<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedAngels - On-Demand Medical Services</title>
    <!-- Tailwind CDN: For prototype/demo only. In production, use PostCSS plugin or Tailwind CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        #chatMessages::-webkit-scrollbar { width: 8px; }
        #chatMessages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #chatMessages::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        #chatMessages::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop { animation: backdropFadeIn 0.2s ease-out; }
        @keyframes backdropFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { animation: modalSlideIn 0.3s ease-out; }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.95) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app"></div>

    <script>
        const state = {
            currentView: 'landing',
            currentRole: null,
            patientRequests: [],
            providerRequests: [],
            providers: [
                { id: 1, name: 'Dr. Sarah Chen', specialty: 'Primary Care', services: ['primary'], available: true, rating: 4.9, completed: 342 },
                { id: 2, name: 'Dr. Michael Torres', specialty: 'Urgent Care', services: ['urgent', 'primary'], available: false, rating: 4.8, completed: 256 },
                { id: 3, name: 'Emily Rodriguez RN', specialty: 'Nursing', services: ['nurse'], available: true, rating: 4.9, completed: 428 },
                { id: 4, name: 'Dr. James Kim', specialty: 'Physical Therapy', services: ['physical'], available: true, rating: 4.7, completed: 198 },
                { id: 5, name: 'Dr. Lisa Wong', specialty: 'Chiropractor', services: ['chiro'], available: true, rating: 4.8, completed: 267 },
                { id: 6, name: 'Dr. Rachel Green', specialty: 'Mental Health', services: ['mental'], available: true, rating: 4.9, completed: 312 },
                { id: 7, name: 'David Martinez MLT', specialty: 'Lab Services', services: ['lab'], available: true, rating: 4.7, completed: 521 },
            ],
            currentProvider: null,
            currentPatient: null,
            aiMessages: [],
            aiContext: {},
            aiState: 'initial',
            requestCounter: 1,
            selectedService: null,
            pendingRequest: null,
            onboardingData: {},
            onboardingStep: 1,
            patientRegistrationData: {},
            patientRegistrationStep: 1,
            showAIPanel: false,
            showModal: null
        };

        const registeredCharities = [
            { id: 'redcross', name: 'American Red Cross' },
            { id: 'doctorswb', name: 'Doctors Without Borders' },
            { id: 'directrelief', name: 'Direct Relief' },
            { id: 'partnersinhealth', name: 'Partners In Health' },
            { id: 'operationsmile', name: 'Operation Smile' },
            { id: 'stjude', name: 'St. Jude Children\'s Research Hospital' },
            { id: 'feedingamerica', name: 'Feeding America' },
            { id: 'habitat', name: 'Habitat for Humanity' },
            { id: 'unitedway', name: 'United Way' },
            { id: 'salvationarmy', name: 'The Salvation Army' }
        ];

        const services = [
            { id: 'primary', name: 'Primary Care', icon: 'ü©∫', basePrice: 75, time: '30-45 min' },
            { id: 'urgent', name: 'Urgent Care', icon: 'üöë', basePrice: 125, time: '20-30 min' },
            { id: 'nurse', name: 'Nursing Visit', icon: 'üíâ', basePrice: 50, time: '20-30 min' },
            { id: 'physical', name: 'Physical Therapy', icon: 'üèÉ', basePrice: 85, time: '45-60 min' },
            { id: 'chiro', name: 'Chiropractor', icon: 'ü¶¥', basePrice: 70, time: '30-40 min' },
            { id: 'mental', name: 'Mental Health', icon: 'üß†', basePrice: 100, time: '50-60 min' },
            { id: 'lab', name: 'Lab/Blood Draw', icon: 'üî¨', basePrice: 40, time: '15-20 min' }
        ];

        const serviceFormConfigs = {
            primary: {
                fields: [
                    { name: 'symptoms', label: 'Primary Symptoms', type: 'textarea', required: true },
                    { name: 'duration', label: 'Duration of Symptoms', type: 'select', options: ['Less than 24 hours', '1-3 days', '3-7 days', 'More than a week'], required: true },
                    { name: 'previousConditions', label: 'Any Previous Medical Conditions?', type: 'text', required: false },
                    { name: 'urgency', label: 'Urgency Level', type: 'select', options: ['Routine', 'Moderate', 'High'], required: true }
                ],
                pricingFactors: { urgency: { 'High': 1.3, 'Moderate': 1.1, 'Routine': 1.0 }}
            },
            urgent: {
                fields: [
                    { name: 'chiefComplaint', label: 'What is the urgent issue?', type: 'textarea', required: true },
                    { name: 'severity', label: 'Pain/Severity Level (1-10)', type: 'select', options: ['1-3 (Mild)', '4-6 (Moderate)', '7-10 (Severe)'], required: true },
                    { name: 'injury', label: 'Is this related to an injury?', type: 'select', options: ['Yes', 'No'], required: true },
                    { name: 'medications', label: 'Current Medications', type: 'text', required: false }
                ],
                pricingFactors: { severity: { '7-10 (Severe)': 1.2, '4-6 (Moderate)': 1.1, '1-3 (Mild)': 1.0 }}
            },
            nurse: {
                fields: [
                    { name: 'serviceType', label: 'Type of Nursing Service', type: 'select', options: ['Wound Care', 'Injection/Medication', 'IV Therapy', 'Vital Signs Check', 'Other'], required: true },
                    { name: 'details', label: 'Service Details', type: 'textarea', required: true },
                    { name: 'equipment', label: 'Special Equipment Needed?', type: 'select', options: ['None', 'Patient will provide', 'Provider should bring'], required: true },
                    { name: 'frequency', label: 'Frequency', type: 'select', options: ['One-time visit', 'Multiple visits needed'], required: true }
                ],
                pricingFactors: { 
                    serviceType: { 'IV Therapy': 1.5, 'Wound Care': 1.2, 'Injection/Medication': 1.0, 'Vital Signs Check': 0.9, 'Other': 1.0 },
                    equipment: { 'Provider should bring': 1.2, 'Patient will provide': 1.0, 'None': 1.0 }
                }
            },
            physical: {
                fields: [
                    { name: 'bodyArea', label: 'Affected Body Area', type: 'select', options: ['Back', 'Neck', 'Shoulder', 'Knee', 'Hip', 'Ankle', 'Other'], required: true },
                    { name: 'painLevel', label: 'Current Pain Level (1-10)', type: 'select', options: ['1-3 (Mild)', '4-6 (Moderate)', '7-10 (Severe)'], required: true },
                    { name: 'injuryDate', label: 'When did the issue start?', type: 'select', options: ['Within last week', '1-4 weeks ago', '1-3 months ago', 'More than 3 months'], required: true },
                    { name: 'priorTherapy', label: 'Previous Physical Therapy?', type: 'select', options: ['Yes', 'No'], required: true },
                    { name: 'goals', label: 'Treatment Goals', type: 'textarea', required: true }
                ],
                pricingFactors: { 
                    painLevel: { '7-10 (Severe)': 1.15, '4-6 (Moderate)': 1.0, '1-3 (Mild)': 1.0 },
                    priorTherapy: { 'Yes': 1.1, 'No': 1.0 }
                }
            },
            chiro: {
                fields: [
                    { name: 'area', label: 'Area of Concern', type: 'select', options: ['Lower Back', 'Upper Back', 'Neck', 'Full Spine', 'Other'], required: true },
                    { name: 'issueType', label: 'Issue Type', type: 'select', options: ['Pain', 'Stiffness', 'Injury', 'Maintenance/Wellness'], required: true },
                    { name: 'duration', label: 'How long has this been an issue?', type: 'select', options: ['Less than a week', '1-4 weeks', '1-6 months', 'Chronic (6+ months)'], required: true },
                    { name: 'previousAdjustments', label: 'Previous chiropractic care?', type: 'select', options: ['Yes, recently', 'Yes, but not recently', 'No'], required: true }
                ],
                pricingFactors: { 
                    area: { 'Full Spine': 1.3, 'Lower Back': 1.0, 'Upper Back': 1.0, 'Neck': 1.0, 'Other': 1.0 },
                    issueType: { 'Injury': 1.2, 'Pain': 1.0, 'Stiffness': 1.0, 'Maintenance/Wellness': 0.9 }
                }
            },
            mental: {
                fields: [
                    { name: 'sessionType', label: 'Session Type', type: 'select', options: ['Initial Consultation', 'Follow-up Session', 'Crisis Support'], required: true },
                    { name: 'concerns', label: 'Primary Concerns', type: 'textarea', required: true },
                    { name: 'previousTherapy', label: 'Previous mental health treatment?', type: 'select', options: ['Yes', 'No'], required: true },
                    { name: 'sessionLength', label: 'Preferred Session Length', type: 'select', options: ['30 minutes', '50 minutes', '90 minutes'], required: true }
                ],
                pricingFactors: { 
                    sessionType: { 'Crisis Support': 1.5, 'Initial Consultation': 1.2, 'Follow-up Session': 1.0 },
                    sessionLength: { '90 minutes': 1.7, '50 minutes': 1.0, '30 minutes': 0.7 }
                }
            },
            lab: {
                fields: [
                    { name: 'testType', label: 'Type of Test', type: 'select', options: ['Blood Draw Only', 'Complete Blood Count', 'Metabolic Panel', 'Lipid Panel', 'Other Labs'], required: true },
                    { name: 'fasting', label: 'Fasting Required?', type: 'select', options: ['Yes', 'No', 'Unsure'], required: true },
                    { name: 'orderSource', label: 'Lab Order From', type: 'select', options: ['I have a lab order', 'Need physician order'], required: true },
                    { name: 'specialRequirements', label: 'Special Requirements', type: 'textarea', required: false }
                ],
                pricingFactors: { 
                    testType: { 'Other Labs': 1.3, 'Complete Blood Count': 1.2, 'Metabolic Panel': 1.2, 'Lipid Panel': 1.1, 'Blood Draw Only': 1.0 },
                    orderSource: { 'Need physician order': 1.4, 'I have a lab order': 1.0 }
                }
            }
        };

        function calculatePrice(serviceId, formData) {
            const service = services.find(s => s.id === serviceId);
            const config = serviceFormConfigs[serviceId];
            if (!service || !config) return service.basePrice;

            let price = service.basePrice;
            
            for (const [field, value] of Object.entries(formData)) {
                if (config.pricingFactors[field] && config.pricingFactors[field][value]) {
                    price *= config.pricingFactors[field][value];
                }
            }

            return Math.round(price);
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = getViewHTML() + getModalHTML();
            attachEventListeners();
        }

        function getViewHTML() {
            switch(state.currentView) {
                case 'landing': return getLandingHTML();
                case 'patient': return getPatientHTML();
                case 'patient-registration': return getPatientRegistrationHTML();
                case 'provider': return getProviderHTML();
                case 'provider-onboarding': return getProviderOnboardingHTML();
                case 'admin': return getAdminHTML();
                case 'patient-ai': return getPatientAIHTML();
                case 'patient-request': return getPatientRequestHTML();
                case 'service-form': return getServiceFormHTML();
                case 'price-confirmation': return getPriceConfirmationHTML();
                default: return getLandingHTML();
            }
        }

        function getLandingHTML() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div class="max-w-6xl w-full">
                        <div class="text-center mb-12 fade-in">
                            <h1 class="text-6xl font-bold text-indigo-600 mb-4">MedAngels</h1>
                            <p class="text-2xl text-gray-600">On-Demand Medical Services</p>
                            <p class="text-lg text-gray-500 mt-2">Like Uber, but for healthcare</p>
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition cursor-pointer fade-in" onclick="selectRole('patient')">
                                <div class="text-6xl mb-4 text-center">üë§</div>
                                <h2 class="text-2xl font-bold text-center mb-3">Patient</h2>
                                <p class="text-gray-600 text-center">Request medical services on-demand</p>
                            </div>
                            
                            <div class="bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition cursor-pointer fade-in" onclick="selectRole('provider')" style="animation-delay: 0.1s">
                                <div class="text-6xl mb-4 text-center">‚öïÔ∏è</div>
                                <h2 class="text-2xl font-bold text-center mb-3">Provider</h2>
                                <p class="text-gray-600 text-center">Accept requests and serve patients</p>
                            </div>
                            
                            <div class="bg-white rounded-2xl shadow-xl p-8 hover:shadow-2xl transition cursor-pointer fade-in" onclick="selectRole('admin')" style="animation-delay: 0.2s">
                                <div class="text-6xl mb-4 text-center">üìä</div>
                                <h2 class="text-2xl font-bold text-center mb-3">Admin</h2>
                                <p class="text-gray-600 text-center">Manage platform and analytics</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPatientHTML() {
            const activeRequests = state.patientRequests.filter(r => r.status !== 'completed');
            const completedRequests = state.patientRequests.filter(r => r.status === 'completed');

            return `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-indigo-600">MedAngels Patient</h1>
                            <button onclick="changeView('landing')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        </div>
                    </nav>

                    <div class="max-w-7xl mx-auto px-4 py-8">
                        ${activeRequests.length === 0 && completedRequests.length === 0 ? `
                            <div class="mb-8">
                                <h2 class="text-3xl font-bold mb-2">Select a Service</h2>
                                <p class="text-gray-600 mb-6">Choose the medical service you need</p>
                                
                                <div class="grid md:grid-cols-3 gap-6">
                                    ${services.map(service => `
                                        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition cursor-pointer" onclick="selectService('${service.id}')">
                                            <div class="text-5xl mb-4">${service.icon}</div>
                                            <h3 class="text-xl font-bold mb-2">${service.name}</h3>
                                            <div class="text-3xl font-bold text-indigo-600 mb-2">From $${service.basePrice}</div>
                                            <p class="text-gray-600 text-sm">‚è±Ô∏è ${service.time}</p>
                                            <p class="text-gray-500 text-xs mt-2">*Final price based on your needs</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${activeRequests.length > 0 ? `
                            <div class="mb-8">
                                <h3 class="text-2xl font-bold mb-4">Active Requests</h3>
                                <div class="space-y-4">
                                    ${activeRequests.map(req => `
                                        <div class="bg-white rounded-xl shadow p-6">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-lg">${req.service}</h4>
                                                    <p class="text-gray-600 mt-1">${req.description || 'Service request'}</p>
                                                    ${req.status === 'matched' ? `
                                                        <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                                            <p class="text-yellow-800 font-semibold">üîç Finding available provider...</p>
                                                        </div>
                                                    ` : ''}
                                                    ${req.provider && req.status !== 'matched' ? `
                                                        <div class="mt-3 p-4 bg-green-50 border border-green-200 rounded-lg">
                                                            <p class="text-green-800 font-semibold mb-2">‚úì Provider Matched!</p>
                                                            <div class="flex items-center gap-3 mb-2">
                                                                <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xl">
                                                                    ${req.provider.charAt(0)}
                                                                </div>
                                                                <div>
                                                                    <p class="font-bold text-gray-900">${req.provider}</p>
                                                                    <p class="text-sm text-gray-600">‚≠ê 4.9 ‚Ä¢ 342 services</p>
                                                                </div>
                                                            </div>
                                                            ${req.scheduledTime ? `
                                                                <p class="text-gray-700 mt-2">
                                                                    <span class="font-semibold">üìÖ Scheduled:</span> ${req.scheduledTime}
                                                                </p>
                                                            ` : ''}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                <div class="text-right ml-4">
                                                    <div class="text-2xl font-bold text-indigo-600">$${req.price}</div>
                                                    <div class="mt-2">
                                                        ${req.status === 'pending' ? '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">Pending</span>' : ''}
                                                        ${req.status === 'matched' ? '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">Matching...</span>' : ''}
                                                        ${req.status === 'accepted' ? '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">Confirmed</span>' : ''}
                                                        ${req.status === 'in-progress' ? '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">In Progress</span>' : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="mt-6">
                                    <h3 class="text-xl font-bold mb-4">Need another service?</h3>
                                    <div class="grid md:grid-cols-3 gap-4">
                                        ${services.slice(0, 3).map(service => `
                                            <div class="bg-white rounded-lg shadow p-4 hover:shadow-lg transition cursor-pointer" onclick="selectService('${service.id}')">
                                                <div class="flex items-center gap-3">
                                                    <div class="text-3xl">${service.icon}</div>
                                                    <div>
                                                        <h4 class="font-bold">${service.name}</h4>
                                                        <p class="text-sm text-indigo-600">From $${service.basePrice}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${completedRequests.length > 0 ? `
                            <div>
                                <h3 class="text-2xl font-bold mb-4">Service History</h3>
                                <div class="space-y-4">
                                    ${completedRequests.map(req => `
                                        <div class="bg-white rounded-xl shadow p-6 opacity-75">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h4 class="font-bold text-lg">${req.service}</h4>
                                                    <p class="text-gray-600">${req.provider} ‚Ä¢ ${req.scheduledTime}</p>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-xl font-bold">$${req.price}</div>
                                                    <div class="text-green-600 text-sm mt-1">‚úì Completed</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Floating AI Assistant Button -->
                    <button onclick="toggleAIAssistant()" 
                        class="fixed bottom-6 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl hover:bg-indigo-700 transition-all duration-300 flex items-center justify-center z-50 hover:scale-110"
                        style="box-shadow: 0 10px 40px rgba(79, 70, 229, 0.4);">
                        <span class="text-3xl">üí¨</span>
                    </button>
                    
                    <!-- AI Assistant Slide-in Panel -->
                    ${state.showAIPanel ? getAIAssistantPanel() : ''}
                </div>
            `;
        }
        
        function getAIAssistantPanel() {
            return `
                <div class="fixed inset-0 z-50 overflow-hidden">
                    <div class="absolute inset-0 bg-gray-900 bg-opacity-50 transition-opacity" onclick="toggleAIAssistant()"></div>
                    <div class="fixed inset-y-0 right-0 max-w-md w-full bg-white shadow-2xl transform transition-transform duration-300 ease-in-out flex flex-col">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-white">AI Medical Assistant</h3>
                                <p class="text-indigo-100 text-sm">Describe your needs naturally</p>
                            </div>
                            <button onclick="toggleAIAssistant()" class="text-white hover:text-gray-200 transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Messages -->
                        <div id="chatMessages" class="flex-1 p-6 overflow-y-auto bg-gray-50">
                            ${state.aiMessages.length === 0 ? `
                                <div class="flex items-center justify-center h-full">
                                    <div class="text-center text-gray-500">
                                        <div class="text-6xl mb-4">ü§ñ</div>
                                        <p class="text-lg font-semibold">How can I help you today?</p>
                                        <p class="text-sm mt-2 text-gray-400">Example: "I need a physical therapist for my back pain"</p>
                                    </div>
                                </div>
                            ` : state.aiMessages.map(msg => `
                                <div class="mb-4 ${msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'} animate-fadeIn">
                                    <div class="max-w-xs ${msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800 shadow'} rounded-2xl px-4 py-3">
                                        ${msg.content}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Input -->
                        <div class="border-t bg-white p-4">
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="aiInput" 
                                    placeholder="Type your message..." 
                                    class="flex-1 px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                    onkeypress="if(event.key==='Enter') sendAIMessage()">
                                <button onclick="sendAIMessage()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition font-semibold">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPatientAIHTML() {
            return `
                <div class="min-h-screen bg-gray-50 flex flex-col">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-indigo-600">AI Medical Assistant</h1>
                            <button onclick="changeView('patient')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        </div>
                    </nav>

                    <div class="flex-1 max-w-4xl w-full mx-auto px-4 py-8 flex flex-col">
                        <div class="flex-1 bg-white rounded-xl shadow-lg flex flex-col" style="height: calc(100vh - 250px);">
                            <div id="chatMessages" class="flex-1 p-6 overflow-y-auto">
                                ${state.aiMessages.length === 0 ? `
                                    <div class="flex items-center justify-center h-full">
                                        <div class="text-center text-gray-500">
                                            <div class="text-6xl mb-4">üí¨</div>
                                            <p class="text-lg font-semibold">Describe what medical service you need</p>
                                            <p class="text-sm mt-2 text-gray-400">Example: "I need a physical therapist for my back pain"</p>
                                        </div>
                                    </div>
                                ` : state.aiMessages.map(msg => `
                                    <div class="mb-4 ${msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'}">
                                        <div class="max-w-md ${msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'} rounded-2xl px-5 py-3">
                                            ${msg.content}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="border-t p-4">
                                <div class="flex gap-2">
                                    <input 
                                        type="text" 
                                        id="aiInput" 
                                        placeholder="Type your message..." 
                                        class="flex-1 px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                        onkeypress="if(event.key==='Enter') sendAIMessage()">
                                    <button onclick="sendAIMessage()" class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 transition font-semibold">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPatientRequestHTML() {
            return `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-indigo-600">Select Service</h1>
                            <button onclick="changeView('landing')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        </div>
                    </nav>

                    <div class="max-w-7xl mx-auto px-4 py-8">
                        <div class="grid md:grid-cols-3 gap-6">
                            ${services.map(service => `
                                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition cursor-pointer" onclick="selectService('${service.id}')">
                                    <div class="text-5xl mb-4">${service.icon}</div>
                                    <h3 class="text-xl font-bold mb-2">${service.name}</h3>
                                    <div class="text-3xl font-bold text-indigo-600 mb-2">From $${service.basePrice}</div>
                                    <p class="text-gray-600 text-sm">‚è±Ô∏è ${service.time}</p>
                                    <p class="text-gray-500 text-xs mt-2">*Final price based on your needs</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function getServiceFormHTML() {
            const service = services.find(s => s.id === state.selectedService);
            const config = serviceFormConfigs[state.selectedService];
            
            if (!service || !config) return getPatientRequestHTML();

            return `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div>
                                <h1 class="text-2xl font-bold text-indigo-600">${service.icon} ${service.name}</h1>
                                <p class="text-gray-600 text-sm">Base price: $${service.basePrice} ‚Ä¢ ${service.time}</p>
                            </div>
                            <button onclick="backToServiceSelection()" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        </div>
                    </nav>

                    <div class="max-w-4xl mx-auto px-4 py-8">
                        <div class="bg-white rounded-xl shadow-lg p-8">
                            <h2 class="text-xl font-bold mb-6">Tell us about your needs</h2>
                            
                            <form id="serviceForm" onsubmit="submitServiceForm(event)" class="space-y-6">
                                ${config.fields.map(field => {
                                    if (field.type === 'textarea') {
                                        return `
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                    ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                                                </label>
                                                <textarea 
                                                    name="${field.name}" 
                                                    rows="3"
                                                    ${field.required ? 'required' : ''}
                                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                                    placeholder="Please provide details..."></textarea>
                                            </div>
                                        `;
                                    } else if (field.type === 'select') {
                                        return `
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                    ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                                                </label>
                                                <select 
                                                    name="${field.name}" 
                                                    ${field.required ? 'required' : ''}
                                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                                    onchange="updatePriceEstimate()">
                                                    <option value="">Select an option</option>
                                                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                                </select>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div>
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                    ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                                                </label>
                                                <input 
                                                    type="text" 
                                                    name="${field.name}" 
                                                    ${field.required ? 'required' : ''}
                                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                                    placeholder="Enter ${field.label.toLowerCase()}">
                                            </div>
                                        `;
                                    }
                                }).join('')}

                                <div class="border-t pt-6 mt-6">
                                    <div class="bg-indigo-50 rounded-lg p-6 mb-6">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <p class="text-sm text-gray-600">Estimated Price</p>
                                                <p class="text-4xl font-bold text-indigo-600" id="priceEstimate">$${service.basePrice}</p>
                                                <p class="text-xs text-gray-500 mt-1">*Final price shown after form completion</p>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 transition text-lg font-semibold">
                                        Continue to Price Confirmation
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPriceConfirmationHTML() {
            const request = state.pendingRequest;
            if (!request) return getPatientHTML();

            return `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-indigo-600">Confirm Your Request</h1>
                            <button onclick="changeView('patient')" class="text-gray-600 hover:text-gray-800">‚Üê Cancel</button>
                        </div>
                    </nav>

                    <div class="max-w-4xl mx-auto px-4 py-8">
                        <div class="bg-white rounded-xl shadow-lg p-8">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">${request.icon}</div>
                                <h2 class="text-3xl font-bold mb-2">${request.service}</h2>
                                <p class="text-gray-600">${request.time}</p>
                            </div>

                            <div class="border-t border-b py-6 mb-6">
                                <h3 class="font-bold mb-4">Request Details:</h3>
                                <div class="space-y-3 text-sm">
                                    ${Object.entries(request.formData).map(([key, value]) => `
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</span>
                                            <span class="font-semibold">${value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-green-50 rounded-lg p-6 mb-8">
                                <div class="text-center">
                                    <p class="text-gray-600 mb-2">Final Price</p>
                                    <p class="text-5xl font-bold text-green-600 mb-2">$${request.price}</p>
                                    <p class="text-sm text-gray-500">Price confirmed based on your needs</p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <button onclick="acceptRequest()" class="w-full bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 transition text-lg font-semibold">
                                    Accept & Find Provider
                                </button>
                                <button onclick="changeView('patient')" class="w-full bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 transition">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPatientRegistrationHTML() {
            const step = state.patientRegistrationStep;
            
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-indigo-600">Patient Registration</h1>
                            <button onclick="changeView('landing')" class="text-gray-600 hover:text-gray-800">‚Üê Cancel</button>
                        </div>
                    </nav>

                    <div class="max-w-4xl mx-auto px-4 py-8">
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold ${step >= 1 ? 'text-indigo-600' : 'text-gray-400'}">1. Personal Info</span>
                                <span class="text-sm font-semibold ${step >= 2 ? 'text-indigo-600' : 'text-gray-400'}">2. Medical Info</span>
                                <span class="text-sm font-semibold ${step >= 3 ? 'text-indigo-600' : 'text-gray-400'}">3. Payment</span>
                                <span class="text-sm font-semibold ${step >= 4 ? 'text-indigo-600' : 'text-gray-400'}">4. Review</span>
                            </div>
                            <div class="h-2 bg-gray-200 rounded-full">
                                <div class="h-2 bg-indigo-600 rounded-full transition-all duration-300" style="width: ${(step / 4) * 100}%"></div>
                            </div>
                        </div>

                        ${step === 1 ? getPatientRegStep1HTML() : ''}
                        ${step === 2 ? getPatientRegStep2HTML() : ''}
                        ${step === 3 ? getPatientRegStep3HTML() : ''}
                        ${step === 4 ? getPatientRegStep4HTML() : ''}
                    </div>
                </div>
            `;
        }

        function getPatientRegStep1HTML() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-2">Welcome to MedAngels!</h2>
                    <p class="text-gray-600 mb-8">Let's create your patient profile.</p>

                    <form id="patientRegForm1" onsubmit="submitPatientRegStep1(event)" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    First Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="firstName" required value="${state.patientRegistrationData.firstName || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Last Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="lastName" required value="${state.patientRegistrationData.lastName || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Date of Birth <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="dob" required value="${state.patientRegistrationData.dob || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Phone Number <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="phone" required value="${state.patientRegistrationData.phone || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="(555) 123-4567">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Email Address <span class="text-red-500">*</span>
                            </label>
                            <input type="email" name="email" required value="${state.patientRegistrationData.email || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Address <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="address" required value="${state.patientRegistrationData.address || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="123 Main Street">
                        </div>

                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    City <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="city" required value="${state.patientRegistrationData.city || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    State <span class="text-red-500">*</span>
                                </label>
                                <select name="state" required class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                    <option value="">Select</option>
                                    <option value="NC" ${state.patientRegistrationData.state === 'NC' ? 'selected' : ''}>NC</option>
                                    <option value="CA" ${state.patientRegistrationData.state === 'CA' ? 'selected' : ''}>CA</option>
                                    <option value="NY" ${state.patientRegistrationData.state === 'NY' ? 'selected' : ''}>NY</option>
                                    <option value="TX" ${state.patientRegistrationData.state === 'TX' ? 'selected' : ''}>TX</option>
                                    <option value="FL" ${state.patientRegistrationData.state === 'FL' ? 'selected' : ''}>FL</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    ZIP Code <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="zip" required value="${state.patientRegistrationData.zip || ''}"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 transition text-lg font-semibold">
                            Continue to Medical Information
                        </button>
                    </form>
                </div>
            `;
        }

        function getPatientRegStep2HTML() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-2">Medical Information</h2>
                    <p class="text-gray-600 mb-8">Help us provide better care by sharing your medical history.</p>

                    <form id="patientRegForm2" onsubmit="submitPatientRegStep2(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Current Medications
                            </label>
                            <textarea name="medications" rows="3" value="${state.patientRegistrationData.medications || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="List any medications you're currently taking..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Allergies
                            </label>
                            <textarea name="allergies" rows="2" value="${state.patientRegistrationData.allergies || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="List any known allergies..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Medical Conditions
                            </label>
                            <textarea name="conditions" rows="3" value="${state.patientRegistrationData.conditions || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="List any chronic conditions or past medical issues..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Emergency Contact Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="emergencyName" required value="${state.patientRegistrationData.emergencyName || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Emergency Contact Phone <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="emergencyPhone" required value="${state.patientRegistrationData.emergencyPhone || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                        </div>

                        <div class="flex gap-4">
                            <button type="button" onclick="goToPatientRegStep(1)" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 transition">
                                ‚Üê Back
                            </button>
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 transition text-lg font-semibold">
                                Continue to Payment
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getPatientRegStep3HTML() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-2">Payment Information</h2>
                    <p class="text-gray-600 mb-8">Choose how you'd like to pay for services.</p>

                    <form id="patientRegForm3" onsubmit="submitPatientRegStep3(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-4">
                                Primary Payment Method <span class="text-red-500">*</span>
                            </label>
                            
                            <div class="space-y-3">
                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:border-indigo-600 transition ${state.patientRegistrationData.paymentType === 'insurance' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'}">
                                    <input type="radio" name="paymentType" value="insurance" 
                                        ${state.patientRegistrationData.paymentType === 'insurance' ? 'checked' : ''}
                                        onchange="updatePaymentForm()" class="mt-1 mr-3 w-5 h-5 text-indigo-600">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">üè• Insurance</div>
                                        <p class="text-sm text-gray-600 mt-1">Bill through your health insurance provider</p>
                                    </div>
                                </label>

                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:border-indigo-600 transition ${state.patientRegistrationData.paymentType === 'credit' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'}">
                                    <input type="radio" name="paymentType" value="credit"
                                        ${state.patientRegistrationData.paymentType === 'credit' ? 'checked' : ''}
                                        onchange="updatePaymentForm()" class="mt-1 mr-3 w-5 h-5 text-indigo-600">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">üí≥ Credit/Debit Card</div>
                                        <p class="text-sm text-gray-600 mt-1">Direct payment with card</p>
                                    </div>
                                </label>

                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:border-indigo-600 transition ${state.patientRegistrationData.paymentType === 'hsa' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'}">
                                    <input type="radio" name="paymentType" value="hsa"
                                        ${state.patientRegistrationData.paymentType === 'hsa' ? 'checked' : ''}
                                        onchange="updatePaymentForm()" class="mt-1 mr-3 w-5 h-5 text-indigo-600">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">üè¶ HSA/FSA</div>
                                        <p class="text-sm text-gray-600 mt-1">Health Savings or Flexible Spending Account</p>
                                    </div>
                                </label>

                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:border-indigo-600 transition ${state.patientRegistrationData.paymentType === 'financing' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'}">
                                    <input type="radio" name="paymentType" value="financing"
                                        ${state.patientRegistrationData.paymentType === 'financing' ? 'checked' : ''}
                                        onchange="updatePaymentForm()" class="mt-1 mr-3 w-5 h-5 text-indigo-600">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">üìÖ Financing</div>
                                        <p class="text-sm text-gray-600 mt-1">Pay over time with approved financing</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div id="insuranceFields" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Insurance Provider <span class="text-red-500">*</span>
                                </label>
                                <select name="insuranceProvider" id="insuranceProviderSelect"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                    <option value="">Select provider</option>
                                    <option value="bcbs">Blue Cross Blue Shield</option>
                                    <option value="aetna">Aetna</option>
                                    <option value="uhc">UnitedHealthcare</option>
                                    <option value="cigna">Cigna</option>
                                    <option value="humana">Humana</option>
                                    <option value="medicare">Medicare</option>
                                    <option value="medicaid">Medicaid</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Member ID <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="memberId" id="memberIdInput"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Group Number
                                </label>
                                <input type="text" name="groupNumber"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                            </div>
                        </div>

                        <div id="creditFields" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Card Number <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="cardNumber" id="cardNumberInput" maxlength="19"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                    placeholder="1234 5678 9012 3456">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Expiry Date <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" name="cardExpiry" id="cardExpiryInput" maxlength="5"
                                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                        placeholder="MM/YY">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        CVV <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" name="cardCvv" id="cardCvvInput" maxlength="4"
                                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                        placeholder="123">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Name on Card <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="cardName" id="cardNameInput"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                            </div>
                        </div>

                        <div id="hsaFields" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Account Type <span class="text-red-500">*</span>
                                </label>
                                <select name="hsaType" id="hsaTypeSelect"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                    <option value="">Select type</option>
                                    <option value="hsa">Health Savings Account (HSA)</option>
                                    <option value="fsa">Flexible Spending Account (FSA)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Card Number <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="hsaCard" id="hsaCardInput"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                            </div>
                        </div>

                        <div id="financingFields" class="hidden space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p class="text-sm text-blue-900 font-semibold mb-2">üí° Financing Options</p>
                                <p class="text-sm text-blue-800">Subject to credit approval. Monthly payment plans available through our partners.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Preferred Partner <span class="text-red-500">*</span>
                                </label>
                                <select name="financingPartner" id="financingPartnerSelect"
                                    class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                    <option value="">Select financing partner</option>
                                    <option value="carecredit">CareCredit</option>
                                    <option value="affirm">Affirm</option>
                                    <option value="lendingclub">LendingClub</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="flex items-start">
                                <input type="checkbox" name="agreeTerms" required class="mt-1 mr-3 w-5 h-5 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">
                                    I authorize MedAngels to charge the selected payment method for services rendered. 
                                    I understand that payment is due at time of service unless otherwise arranged.
                                </span>
                            </label>
                        </div>

                        <div class="flex gap-4">
                            <button type="button" onclick="goToPatientRegStep(2)" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 transition">
                                ‚Üê Back
                            </button>
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 transition text-lg font-semibold">
                                Continue to Review
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getPatientRegStep4HTML() {
            const data = state.patientRegistrationData;
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-2">Review Your Information</h2>
                    <p class="text-gray-600 mb-8">Please review your details before completing registration.</p>

                    <div class="space-y-6">
                        <div class="border rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg">Personal Information</h3>
                                <button onclick="goToPatientRegStep(1)" class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold">Edit</button>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div><span class="text-gray-600">Name:</span> <span class="font-semibold ml-2">${data.firstName} ${data.lastName}</span></div>
                                <div><span class="text-gray-600">DOB:</span> <span class="font-semibold ml-2">${data.dob}</span></div>
                                <div><span class="text-gray-600">Phone:</span> <span class="font-semibold ml-2">${data.phone}</span></div>
                                <div><span class="text-gray-600">Email:</span> <span class="font-semibold ml-2">${data.email}</span></div>
                                <div class="md:col-span-2"><span class="text-gray-600">Address:</span> <span class="font-semibold ml-2">${data.address}, ${data.city}, ${data.state} ${data.zip}</span></div>
                            </div>
                        </div>

                        <div class="border rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg">Medical Information</h3>
                                <button onclick="goToPatientRegStep(2)" class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold">Edit</button>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div><span class="text-gray-600">Medications:</span> <span class="ml-2">${data.medications || 'None listed'}</span></div>
                                <div><span class="text-gray-600">Allergies:</span> <span class="ml-2">${data.allergies || 'None listed'}</span></div>
                                <div><span class="text-gray-600">Conditions:</span> <span class="ml-2">${data.conditions || 'None listed'}</span></div>
                                <div><span class="text-gray-600">Emergency Contact:</span> <span class="ml-2">${data.emergencyName} - ${data.emergencyPhone}</span></div>
                            </div>
                        </div>

                        <div class="border rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg">Payment Method</h3>
                                <button onclick="goToPatientRegStep(3)" class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold">Edit</button>
                            </div>
                            ${data.paymentType === 'insurance' ? `
                                <div class="flex items-center gap-3 bg-blue-50 px-4 py-3 rounded-lg">
                                    <span class="text-2xl">üè•</span>
                                    <div>
                                        <div class="font-semibold">Insurance</div>
                                        <p class="text-sm text-gray-600">${data.insuranceProvider} - Member ID: ${data.memberId}</p>
                                    </div>
                                </div>
                            ` : ''}
                            ${data.paymentType === 'credit' ? `
                                <div class="flex items-center gap-3 bg-blue-50 px-4 py-3 rounded-lg">
                                    <span class="text-2xl">üí≥</span>
                                    <div>
                                        <div class="font-semibold">Credit/Debit Card</div>
                                        <p class="text-sm text-gray-600">Card ending in ${data.cardNumber ? data.cardNumber.slice(-4) : '****'}</p>
                                    </div>
                                </div>
                            ` : ''}
                            ${data.paymentType === 'hsa' ? `
                                <div class="flex items-center gap-3 bg-blue-50 px-4 py-3 rounded-lg">
                                    <span class="text-2xl">üè¶</span>
                                    <div>
                                        <div class="font-semibold">HSA/FSA</div>
                                        <p class="text-sm text-gray-600">${data.hsaType === 'hsa' ? 'Health Savings Account' : 'Flexible Spending Account'}</p>
                                    </div>
                                </div>
                            ` : ''}
                            ${data.paymentType === 'financing' ? `
                                <div class="flex items-center gap-3 bg-blue-50 px-4 py-3 rounded-lg">
                                    <span class="text-2xl">üìÖ</span>
                                    <div>
                                        <div class="font-semibold">Financing</div>
                                        <p class="text-sm text-gray-600">${data.financingPartner}</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <div class="flex items-start gap-3">
                                <span class="text-3xl">‚úÖ</span>
                                <div>
                                    <h4 class="font-bold text-green-900 mb-2">Ready to Get Started!</h4>
                                    <p class="text-sm text-green-800">By completing registration, you agree to MedAngels's Terms of Service and Privacy Policy.</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="goToPatientRegStep(3)" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 transition">
                                ‚Üê Back
                            </button>
                            <button onclick="completePatientRegistration()" class="flex-1 bg-green-600 text-white py-4 rounded-lg hover:bg-green-700 transition text-lg font-semibold">
                                Complete Registration üéâ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getProviderOnboardingHTML() {
            const step = state.onboardingStep;
            
            return `
                <div class="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-indigo-600">Provider Registration</h1>
                            <button onclick="changeView('landing')" class="text-gray-600 hover:text-gray-800">‚Üê Cancel</button>
                        </div>
                    </nav>

                    <div class="max-w-4xl mx-auto px-4 py-8">
                        <!-- Progress Bar -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold ${step >= 1 ? 'text-indigo-600' : 'text-gray-400'}">1. Basic Info</span>
                                <span class="text-sm font-semibold ${step >= 2 ? 'text-indigo-600' : 'text-gray-400'}">2. Services</span>
                                <span class="text-sm font-semibold ${step >= 3 ? 'text-indigo-600' : 'text-gray-400'}">3. Compensation</span>
                                <span class="text-sm font-semibold ${step >= 4 ? 'text-indigo-600' : 'text-gray-400'}">4. Review</span>
                            </div>
                            <div class="h-2 bg-gray-200 rounded-full">
                                <div class="h-2 bg-indigo-600 rounded-full transition-all duration-300" style="width: ${(step / 4) * 100}%"></div>
                            </div>
                        </div>

                        ${step === 1 ? getOnboardingStep1HTML() : ''}
                        ${step === 2 ? getOnboardingStep2HTML() : ''}
                        ${step === 3 ? getOnboardingStep3HTML() : ''}
                        ${step === 4 ? getOnboardingStep4HTML() : ''}
                    </div>
                </div>
            `;
        }

        function getOnboardingStep1HTML() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-2">Welcome to MedAngels!</h2>
                    <p class="text-gray-600 mb-8">Let's get you set up to start helping patients.</p>

                    <form id="onboardingForm1" onsubmit="submitOnboardingStep1(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Full Name <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="text" 
                                name="fullName" 
                                required
                                value="${state.onboardingData.fullName || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="Dr. Jane Smith">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Professional Title <span class="text-red-500">*</span>
                            </label>
                            <select 
                                name="title" 
                                required
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                <option value="">Select your title</option>
                                <option value="MD" ${state.onboardingData.title === 'MD' ? 'selected' : ''}>Medical Doctor (MD)</option>
                                <option value="DO" ${state.onboardingData.title === 'DO' ? 'selected' : ''}>Doctor of Osteopathic Medicine (DO)</option>
                                <option value="RN" ${state.onboardingData.title === 'RN' ? 'selected' : ''}>Registered Nurse (RN)</option>
                                <option value="NP" ${state.onboardingData.title === 'NP' ? 'selected' : ''}>Nurse Practitioner (NP)</option>
                                <option value="PA" ${state.onboardingData.title === 'PA' ? 'selected' : ''}>Physician Assistant (PA)</option>
                                <option value="PT" ${state.onboardingData.title === 'PT' ? 'selected' : ''}>Physical Therapist (PT)</option>
                                <option value="DC" ${state.onboardingData.title === 'DC' ? 'selected' : ''}>Doctor of Chiropractic (DC)</option>
                                <option value="LCSW" ${state.onboardingData.title === 'LCSW' ? 'selected' : ''}>Licensed Clinical Social Worker (LCSW)</option>
                                <option value="PhD" ${state.onboardingData.title === 'PhD' ? 'selected' : ''}>Psychologist (PhD)</option>
                                <option value="MLT" ${state.onboardingData.title === 'MLT' ? 'selected' : ''}>Medical Lab Technician (MLT)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                License Number <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="text" 
                                name="licenseNumber" 
                                required
                                value="${state.onboardingData.licenseNumber || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="Enter your license number">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                State Licensed In <span class="text-red-500">*</span>
                            </label>
                            <select 
                                name="state" 
                                required
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                <option value="">Select state</option>
                                <option value="NC" ${state.onboardingData.state === 'NC' ? 'selected' : ''}>North Carolina</option>
                                <option value="CA" ${state.onboardingData.state === 'CA' ? 'selected' : ''}>California</option>
                                <option value="NY" ${state.onboardingData.state === 'NY' ? 'selected' : ''}>New York</option>
                                <option value="TX" ${state.onboardingData.state === 'TX' ? 'selected' : ''}>Texas</option>
                                <option value="FL" ${state.onboardingData.state === 'FL' ? 'selected' : ''}>Florida</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Years of Experience <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="number" 
                                name="experience" 
                                required
                                min="0"
                                max="50"
                                value="${state.onboardingData.experience || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="5">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Phone Number <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="tel" 
                                name="phone" 
                                required
                                value="${state.onboardingData.phone || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="(555) 123-4567">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Email Address <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="email" 
                                name="email" 
                                required
                                value="${state.onboardingData.email || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="doctor@example.com">
                        </div>

                        <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 transition text-lg font-semibold">
                            Continue to Services
                        </button>
                    </form>
                </div>
            `;
        }

        function getOnboardingStep2HTML() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-2">Select Services You Provide</h2>
                    <p class="text-gray-600 mb-8">Choose all the services you can offer to patients.</p>

                    <form id="onboardingForm2" onsubmit="submitOnboardingStep2(event)" class="space-y-6">
                        <div class="grid md:grid-cols-2 gap-4">
                            ${services.map(service => `
                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:border-indigo-600 transition ${state.onboardingData.services && state.onboardingData.services.includes(service.id) ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'}">
                                    <input 
                                        type="checkbox" 
                                        name="services" 
                                        value="${service.id}"
                                        ${state.onboardingData.services && state.onboardingData.services.includes(service.id) ? 'checked' : ''}
                                        class="mt-1 mr-3 w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-600">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-2xl">${service.icon}</span>
                                            <span class="font-semibold text-gray-900">${service.name}</span>
                                        </div>
                                        <p class="text-sm text-gray-500 mt-1">Base: $${service.basePrice} √¢‚Ç¨¬¢ ${service.time}</p>
                                    </div>
                                </label>
                            `).join('')}
                        </div>

                        <div class="border-t pt-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Service Area (ZIP Code) <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="text" 
                                name="serviceZip" 
                                required
                                value="${state.onboardingData.serviceZip || ''}"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="28173">
                            <p class="text-sm text-gray-500 mt-2">This is the primary area where you'll provide services.</p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Travel Radius (miles) <span class="text-red-500">*</span>
                            </label>
                            <select 
                                name="travelRadius" 
                                required
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                <option value="">Select radius</option>
                                <option value="5" ${state.onboardingData.travelRadius === '5' ? 'selected' : ''}>5 miles</option>
                                <option value="10" ${state.onboardingData.travelRadius === '10' ? 'selected' : ''}>10 miles</option>
                                <option value="15" ${state.onboardingData.travelRadius === '15' ? 'selected' : ''}>15 miles</option>
                                <option value="25" ${state.onboardingData.travelRadius === '25' ? 'selected' : ''}>25 miles</option>
                                <option value="50" ${state.onboardingData.travelRadius === '50' ? 'selected' : ''}>50 miles</option>
                            </select>
                        </div>

                        <div class="flex gap-4">
                            <button type="button" onclick="goToOnboardingStep(1)" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 transition">
                                ‚Üê Back
                            </button>
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 transition text-lg font-semibold">
                                Continue to Compensation
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getOnboardingStep3HTML() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-2">Compensation & Giving</h2>
                    <p class="text-gray-600 mb-8">Choose how you'd like to structure your earnings.</p>

                    <form id="onboardingForm3" onsubmit="submitOnboardingStep3(event)" class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                            <h3 class="font-bold text-lg mb-3 text-blue-900">√∞≈∏‚Äô¬° Compensation Options</h3>
                            <p class="text-sm text-blue-800 mb-4">You can choose to keep your earnings, donate your time completely, or donate proceeds to charity while covering your costs.</p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-4">
                                How would you like to structure your compensation? <span class="text-red-500">*</span>
                            </label>
                            
                            <div class="space-y-3">
                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:border-indigo-600 transition ${state.onboardingData.compensationType === 'keep' ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200'}">
                                    <input 
                                        type="radio" 
                                        name="compensationType" 
                                        value="keep"
                                        ${state.onboardingData.compensationType === 'keep' ? 'checked' : ''}
                                        onchange="updateCompensationForm()"
                                        class="mt-1 mr-3 w-5 h-5 text-indigo-600 focus:ring-2 focus:ring-indigo-600">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">√∞≈∏‚Äô¬∞ Keep Earnings</div>
                                        <p class="text-sm text-gray-600 mt-1">Receive full payment for your services</p>
                                    </div>
                                </label>

                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:border-green-600 transition ${state.onboardingData.compensationType === 'donate-time' ? 'border-green-600 bg-green-50' : 'border-gray-200'}">
                                    <input 
                                        type="radio" 
                                        name="compensationType" 
                                        value="donate-time"
                                        ${state.onboardingData.compensationType === 'donate-time' ? 'checked' : ''}
                                        onchange="updateCompensationForm()"
                                        class="mt-1 mr-3 w-5 h-5 text-green-600 focus:ring-2 focus:ring-green-600">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">√∞≈∏≈Ω¬Å Donate Time (Pro Bono)</div>
                                        <p class="text-sm text-gray-600 mt-1">Provide services for free to those in need</p>
                                        <div class="mt-2 px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full inline-block">
                                            √¢¬≠¬ê Verified Volunteer Badge
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer hover:border-purple-600 transition ${state.onboardingData.compensationType === 'donate-proceeds' ? 'border-purple-600 bg-purple-50' : 'border-gray-200'}">
                                    <input 
                                        type="radio" 
                                        name="compensationType" 
                                        value="donate-proceeds"
                                        ${state.onboardingData.compensationType === 'donate-proceeds' ? 'checked' : ''}
                                        onchange="updateCompensationForm()"
                                        class="mt-1 mr-3 w-5 h-5 text-purple-600 focus:ring-2 focus:ring-purple-600">
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">√¢¬ù¬§√Ø¬∏¬è Donate Proceeds to Charity</div>
                                        <p class="text-sm text-gray-600 mt-1">Patients pay, but all proceeds go to your chosen charity</p>
                                        <div class="mt-2 px-3 py-1 bg-purple-100 text-purple-800 text-xs rounded-full inline-block">
                                            √¢¬≠¬ê Charitable Provider Badge
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div id="charitySelection" class="hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Select Charity <span class="text-red-500">*</span>
                            </label>
                            <select 
                                name="charity" 
                                id="charityDropdown"
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                <option value="">Choose a registered charity</option>
                                ${registeredCharities.map(charity => `
                                    <option value="${charity.id}" ${state.onboardingData.charity === charity.id ? 'selected' : ''}>
                                        ${charity.name}
                                    </option>
                                `).join('')}
                            </select>
                            <p class="text-sm text-gray-500 mt-2">100% of proceeds will be donated to this organization</p>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="font-semibold mb-3">√∞≈∏‚Äú‚Äπ What happens next:</h4>
                            <ul class="space-y-2 text-sm text-gray-700">
                                <li class="flex items-start">
                                    <span class="mr-2">√¢‚Ç¨¬¢</span>
                                    <span>Your profile will display your compensation choice</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="mr-2">√¢‚Ç¨¬¢</span>
                                    <span>Patients can filter providers by donation status</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="mr-2">√¢‚Ç¨¬¢</span>
                                    <span>Tax receipts will be provided for charitable donations</span>
                                </li>
                            </ul>
                        </div>

                        <div class="flex gap-4">
                            <button type="button" onclick="goToOnboardingStep(2)" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 transition">
                                ‚Üê Back
                            </button>
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 transition text-lg font-semibold">
                                Continue to Review
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function getOnboardingStep4HTML() {
            const data = state.onboardingData;
            const selectedServices = services.filter(s => data.services && data.services.includes(s.id));
            const selectedCharity = registeredCharities.find(c => c.id === data.charity);

            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-2">Review Your Information</h2>
                    <p class="text-gray-600 mb-8">Please review your details before completing registration.</p>

                    <div class="space-y-6">
                        <!-- Basic Info -->
                        <div class="border rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg">Basic Information</h3>
                                <button onclick="goToOnboardingStep(1)" class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold">
                                    Edit
                                </button>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Name:</span>
                                    <span class="font-semibold ml-2">${data.fullName}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Title:</span>
                                    <span class="font-semibold ml-2">${data.title}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">License:</span>
                                    <span class="font-semibold ml-2">${data.licenseNumber}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">State:</span>
                                    <span class="font-semibold ml-2">${data.state}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Experience:</span>
                                    <span class="font-semibold ml-2">${data.experience} years</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Phone:</span>
                                    <span class="font-semibold ml-2">${data.phone}</span>
                                </div>
                                <div class="md:col-span-2">
                                    <span class="text-gray-600">Email:</span>
                                    <span class="font-semibold ml-2">${data.email}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Services -->
                        <div class="border rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg">Services Offered</h3>
                                <button onclick="goToOnboardingStep(2)" class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold">
                                    Edit
                                </button>
                            </div>
                            <div class="grid md:grid-cols-2 gap-3">
                                ${selectedServices.map(service => `
                                    <div class="flex items-center gap-2 bg-indigo-50 px-3 py-2 rounded">
                                        <span class="text-xl">${service.icon}</span>
                                        <span class="font-semibold text-sm">${service.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-4 text-sm">
                                <span class="text-gray-600">Service Area:</span>
                                <span class="font-semibold ml-2">${data.serviceZip} (${data.travelRadius} mile radius)</span>
                            </div>
                        </div>

                        <!-- Compensation -->
                        <div class="border rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-lg">Compensation Structure</h3>
                                <button onclick="goToOnboardingStep(3)" class="text-indigo-600 hover:text-indigo-700 text-sm font-semibold">
                                    Edit
                                </button>
                            </div>
                            ${data.compensationType === 'keep' ? `
                                <div class="flex items-center gap-3 bg-blue-50 px-4 py-3 rounded-lg">
                                    <span class="text-2xl">√∞≈∏‚Äô¬∞</span>
                                    <div>
                                        <div class="font-semibold">Keep Earnings</div>
                                        <p class="text-sm text-gray-600">Receiving full payment for services</p>
                                    </div>
                                </div>
                            ` : ''}
                            ${data.compensationType === 'donate-time' ? `
                                <div class="flex items-center gap-3 bg-green-50 px-4 py-3 rounded-lg">
                                    <span class="text-2xl">√∞≈∏≈Ω¬Å</span>
                                    <div>
                                        <div class="font-semibold">Donating Time (Pro Bono)</div>
                                        <p class="text-sm text-gray-600">Providing free services to those in need</p>
                                        <div class="mt-2 px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full inline-block">
                                            √¢¬≠¬ê Verified Volunteer Badge
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            ${data.compensationType === 'donate-proceeds' ? `
                                <div class="flex items-center gap-3 bg-purple-50 px-4 py-3 rounded-lg">
                                    <span class="text-2xl">√¢¬ù¬§√Ø¬∏¬è</span>
                                    <div class="flex-1">
                                        <div class="font-semibold">Donating Proceeds to Charity</div>
                                        <p class="text-sm text-gray-600">All proceeds donated to: <span class="font-semibold">${selectedCharity ? selectedCharity.name : 'Selected Charity'}</span></p>
                                        <div class="mt-2 px-3 py-1 bg-purple-100 text-purple-800 text-xs rounded-full inline-block">
                                            √¢¬≠¬ê Charitable Provider Badge
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <div class="flex items-start gap-3">
                                <span class="text-3xl">√¢≈ì‚Ä¶</span>
                                <div>
                                    <h4 class="font-bold text-green-900 mb-2">Ready to Launch!</h4>
                                    <p class="text-sm text-green-800">By completing registration, you agree to MedAngels's Terms of Service and Provider Agreement.</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="goToOnboardingStep(3)" class="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg hover:bg-gray-300 transition">
                                ‚Üê Back
                            </button>
                            <button onclick="completeOnboarding()" class="flex-1 bg-green-600 text-white py-4 rounded-lg hover:bg-green-700 transition text-lg font-semibold">
                                Complete Registration √∞≈∏≈Ω‚Ä∞
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getProviderHTML() {
            const provider = state.currentProvider || state.providers[0];
            
            // Filter requests to only show those matching this provider's services
            const allPendingRequests = state.providerRequests.filter(r => r.status === 'pending');
            const pendingRequests = allPendingRequests.filter(req => {
                const service = services.find(s => s.name === req.service);
                const serviceId = service ? service.id : null;
                return provider.services && provider.services.includes(serviceId);
            });
            
            const allAcceptedRequests = state.providerRequests.filter(r => r.status === 'accepted' || r.status === 'in-progress');
            const acceptedRequests = allAcceptedRequests.filter(req => {
                const service = services.find(s => s.name === req.service);
                const serviceId = service ? service.id : null;
                return provider.services && provider.services.includes(serviceId);
            });
            
            const completedToday = state.providerRequests.filter(r => {
                if (r.status !== 'completed') return false;
                const service = services.find(s => s.name === r.service);
                const serviceId = service ? service.id : null;
                return provider.services && provider.services.includes(serviceId);
            }).length;
            
            const earningsToday = state.providerRequests.filter(r => {
                if (r.status !== 'completed') return false;
                const service = services.find(s => s.name === r.service);
                const serviceId = service ? service.id : null;
                return provider.services && provider.services.includes(serviceId);
            }).reduce((sum, r) => sum + r.price, 0);

            return `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-white shadow-sm border-b">
                        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div>
                                <h1 class="text-2xl font-bold text-indigo-600">${provider.name}</h1>
                                <p class="text-gray-600">${provider.specialty}</p>
                            </div>
                            <button onclick="changeView('landing')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        </div>
                    </nav>

                    <div class="max-w-7xl mx-auto px-4 py-8">
                        <div class="grid md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-gray-600 mb-2">Availability</p>
                                        <p class="text-2xl font-bold ${provider.available ? 'text-green-600' : 'text-gray-400'}">
                                            ${provider.available ? 'Online' : 'Offline'}
                                        </p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" ${provider.available ? 'checked' : ''} class="sr-only peer" onchange="toggleAvailability()">
                                        <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <p class="text-gray-600 mb-2">Today's Earnings</p>
                                <p class="text-3xl font-bold text-indigo-600">$${earningsToday}</p>
                                <p class="text-sm text-gray-500 mt-1">${completedToday} services completed</p>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <p class="text-gray-600 mb-2">Rating</p>
                                <p class="text-3xl font-bold">‚≠ê ${provider.rating}</p>
                                <p class="text-sm text-gray-500 mt-1">${provider.completed} total services</p>
                            </div>
                        </div>

                        ${pendingRequests.length > 0 ? `
                            <div class="mb-8">
                                <h3 class="text-2xl font-bold mb-4">New Requests ${pendingRequests.length > 0 ? '<span class="pulse-dot">üîî</span>' : ''}</h3>
                                <div class="space-y-4">
                                    ${pendingRequests.map(req => `
                                        <div class="bg-white rounded-xl shadow-lg p-6 border-2 border-indigo-200">
                                            <div class="flex justify-between items-start mb-4">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-3 mb-3">
                                                        <span class="text-4xl">${req.icon || 'ü©∫'}</span>
                                                        <div>
                                                            <h4 class="font-bold text-xl">${req.service}</h4>
                                                            <p class="text-sm text-gray-500">‚è±Ô∏è ${req.time}</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="bg-gray-50 rounded-lg p-4 mb-3">
                                                        <p class="text-sm font-semibold text-gray-700 mb-2">Patient Details:</p>
                                                        ${req.description ? `<p class="text-sm text-gray-600 mb-2">${req.description}</p>` : ''}
                                                        ${req.formData ? Object.entries(req.formData).map(([key, value]) => `
                                                            <div class="text-sm text-gray-600 py-1">
                                                                <span class="font-medium">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</span> ${value}
                                                            </div>
                                                        `).join('') : ''}
                                                    </div>
                                                    
                                                    <p class="text-sm text-gray-500">üìç 5 miles away ‚Ä¢ Requested ${new Date(req.createdAt).toLocaleTimeString()}</p>
                                                </div>
                                                <div class="text-right ml-4">
                                                    <div class="text-3xl font-bold text-indigo-600">$${req.price}</div>
                                                </div>
                                            </div>
                                            <div class="flex gap-3">
                                                <button onclick="acceptProviderRequest(${req.id})" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-bold">
                                                    Accept
                                                </button>
                                                <button onclick="declineRequest(${req.id})" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition">
                                                    Decline
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${acceptedRequests.length > 0 ? `
                            <div class="mb-8">
                                <h3 class="text-2xl font-bold mb-4">Upcoming Appointments</h3>
                                <div class="space-y-4">
                                    ${acceptedRequests.map(req => `
                                        <div class="bg-white rounded-xl shadow p-6">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h4 class="font-bold text-lg">${req.service}</h4>
                                                    <p class="text-gray-600">${req.description}</p>
                                                    <p class="text-indigo-600 mt-2 font-semibold">${req.scheduledTime}</p>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-2xl font-bold text-indigo-600">$${req.price}</div>
                                                    ${req.status === 'accepted' ? `
                                                        <button onclick="startService(${req.id})" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                                            Start Service
                                                        </button>
                                                    ` : ''}
                                                    ${req.status === 'in-progress' ? `
                                                        <button onclick="completeService(${req.id})" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                                            Complete
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${pendingRequests.length === 0 && acceptedRequests.length === 0 ? `
                            <div class="text-center py-20">
                                <div class="text-6xl mb-4">üì±</div>
                                <p class="text-xl text-gray-600">No active requests</p>
                                <p class="text-gray-500 mt-2">New requests will appear here when available</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function getAdminHTML() {
            // High-fidelity data calculations
            const totalRequests = state.patientRequests.length;
            const pendingRequests = state.patientRequests.filter(r => r.status === 'pending' || r.status === 'matched').length;
            const activeRequests = state.patientRequests.filter(r => r.status === 'accepted' || r.status === 'in-progress').length;
            const completedRequests = state.patientRequests.filter(r => r.status === 'completed').length;
            
            const totalRevenue = state.patientRequests.filter(r => r.status === 'completed').reduce((sum, r) => sum + r.price, 0);
            const pendingRevenue = state.patientRequests.filter(r => r.status === 'accepted' || r.status === 'in-progress').reduce((sum, r) => sum + r.price, 0);
            const potentialRevenue = state.patientRequests.filter(r => r.status === 'pending' || r.status === 'matched').reduce((sum, r) => sum + r.price, 0);
            
            const activeProviders = state.providers.filter(p => p.available).length;
            const totalProviders = state.providers.length;
            const utilizationRate = totalProviders > 0 ? Math.round((activeProviders / totalProviders) * 100) : 0;
            
            // NEW: Response time tracking
            const avgResponseTime = state.patientRequests
                .filter(r => r.status === 'matched' || r.status === 'accepted')
                .reduce((sum, r) => sum + (r.ageMinutes || 5), 0) / Math.max(1, state.patientRequests.filter(r => r.status === 'matched' || r.status === 'accepted').length);
            
            // NEW: Peak hours analysis
            const requestsByHour = {};
            state.patientRequests.forEach(req => {
                const hour = new Date(req.createdAt).getHours();
                requestsByHour[hour] = (requestsByHour[hour] || 0) + 1;
            });
            const peakHour = Object.keys(requestsByHour).reduce((a, b) => requestsByHour[a] > requestsByHour[b] ? a : b, 0);
            
            // Service breakdown
            const serviceBreakdown = {};
            state.patientRequests.forEach(req => {
                if (!serviceBreakdown[req.service]) {
                    serviceBreakdown[req.service] = { count: 0, revenue: 0, completed: 0, avgPrice: 0 };
                }
                serviceBreakdown[req.service].count++;
                if (req.status === 'completed') {
                    serviceBreakdown[req.service].revenue += req.price;
                    serviceBreakdown[req.service].completed++;
                }
            });
            
            // Calculate average prices
            Object.keys(serviceBreakdown).forEach(service => {
                const data = serviceBreakdown[service];
                data.avgPrice = data.completed > 0 ? Math.round(data.revenue / data.completed) : 0;
            });
            
            // Provider performance
            const providerPerformance = state.providers.map(provider => {
                const providerRequests = state.patientRequests.filter(r => r.provider === provider.name);
                const completed = providerRequests.filter(r => r.status === 'completed').length;
                const revenue = providerRequests.filter(r => r.status === 'completed').reduce((sum, r) => sum + r.price, 0);
                const active = providerRequests.filter(r => r.status === 'accepted' || r.status === 'in-progress').length;
                const pending = providerRequests.filter(r => r.status === 'pending').length;
                
                return {
                    ...provider,
                    requestCount: providerRequests.length,
                    completedCount: completed,
                    activeCount: active,
                    pendingCount: pending,
                    revenue: revenue,
                    avgRevenue: completed > 0 ? Math.round(revenue / completed) : 0
                };
            }).sort((a, b) => b.revenue - a.revenue);
            
            // Request lifecycle timeline
            const requestTimeline = state.patientRequests.map(req => ({
                ...req,
                createdTime: new Date(req.createdAt).toLocaleString(),
                ageMinutes: Math.round((Date.now() - new Date(req.createdAt).getTime()) / 60000)
            })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Conversion metrics
            const conversionRate = totalRequests > 0 ? Math.round((completedRequests / totalRequests) * 100) : 0;
            const avgRequestValue = completedRequests > 0 ? Math.round(totalRevenue / completedRequests) : 0;
            
            // NEW: Alert thresholds
            const alerts = [];
            if (pendingRequests > 5) alerts.push({ type: 'warning', message: `${pendingRequests} requests awaiting provider match` });
            if (utilizationRate < 40) alerts.push({ type: 'info', message: `Only ${utilizationRate}% provider utilization - consider provider recruitment` });
            if (avgResponseTime > 15) alerts.push({ type: 'warning', message: `Average response time: ${Math.round(avgResponseTime)} minutes - above target` });
            
            return `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-white shadow-sm border-b sticky top-0 z-10">
                        <div class="max-w-7xl mx-auto px-4 py-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-2xl font-bold text-indigo-600">Admin Operations Center</h1>
                                    <p class="text-sm text-gray-500">Real-time platform analytics & monitoring</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button onclick="exportData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold">
                                        üìä Export Data
                                    </button>
                                    <button onclick="changeView('landing')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                                </div>
                            </div>
                            
                            ${alerts.length > 0 ? `
                                <div class="mt-4 space-y-2">
                                    ${alerts.map(alert => `
                                        <div class="px-4 py-2 rounded-lg ${alert.type === 'warning' ? 'bg-yellow-50 border border-yellow-200 text-yellow-800' : 'bg-blue-50 border border-blue-200 text-blue-800'} text-sm">
                                            ${alert.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} ${alert.message}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </nav>

                    <div class="max-w-7xl mx-auto px-4 py-8">
                        <!-- Key Metrics -->
                        <div class="grid md:grid-cols-5 gap-6 mb-8">
                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-indigo-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-600 text-sm mb-1">Total Requests</p>
                                        <p class="text-4xl font-bold text-indigo-600">${totalRequests}</p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            ${pendingRequests} pending ‚Ä¢ ${activeRequests} active
                                        </p>
                                    </div>
                                    <div class="text-3xl">üìä</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-600 text-sm mb-1">Completed</p>
                                        <p class="text-4xl font-bold text-green-600">${completedRequests}</p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            ${conversionRate}% conversion
                                        </p>
                                    </div>
                                    <div class="text-3xl">‚úÖ</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-600 text-sm mb-1">Revenue</p>
                                        <p class="text-4xl font-bold text-purple-600">$${totalRevenue}</p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            $${avgRequestValue} avg
                                        </p>
                                    </div>
                                    <div class="text-3xl">üí∞</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-600 text-sm mb-1">Utilization</p>
                                        <p class="text-4xl font-bold text-blue-600">${utilizationRate}%</p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            ${activeProviders}/${totalProviders} online
                                        </p>
                                    </div>
                                    <div class="text-3xl">üë•</div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-600 text-sm mb-1">Avg Response</p>
                                        <p class="text-4xl font-bold text-orange-600">${Math.round(avgResponseTime)}<span class="text-lg">m</span></p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            Peak: ${peakHour}:00
                                        </p>
                                    </div>
                                    <div class="text-3xl">‚ö°</div>
                                </div>
                            </div>
                        </div>

                        <!-- Request Lifecycle Pipeline -->
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                            <h3 class="text-xl font-bold mb-6">Request Lifecycle Pipeline</h3>
                            <div class="grid grid-cols-5 gap-4">
                                <div class="text-center">
                                    <div class="bg-yellow-100 rounded-lg p-4 mb-2">
                                        <p class="text-3xl font-bold text-yellow-700">${state.patientRequests.filter(r => r.status === 'pending').length}</p>
                                    </div>
                                    <p class="text-sm font-semibold text-gray-700">Pending</p>
                                    <p class="text-xs text-gray-500">Awaiting match</p>
                                </div>
                                
                                <div class="flex items-center justify-center text-2xl text-gray-300">‚Üí</div>
                                
                                <div class="text-center">
                                    <div class="bg-orange-100 rounded-lg p-4 mb-2">
                                        <p class="text-3xl font-bold text-orange-700">${state.patientRequests.filter(r => r.status === 'matched').length}</p>
                                    </div>
                                    <p class="text-sm font-semibold text-gray-700">Matched</p>
                                    <p class="text-xs text-gray-500">Finding provider</p>
                                </div>
                                
                                <div class="flex items-center justify-center text-2xl text-gray-300">‚Üí</div>
                                
                                <div class="text-center">
                                    <div class="bg-blue-100 rounded-lg p-4 mb-2">
                                        <p class="text-3xl font-bold text-blue-700">${state.patientRequests.filter(r => r.status === 'accepted').length}</p>
                                    </div>
                                    <p class="text-sm font-semibold text-gray-700">Accepted</p>
                                    <p class="text-xs text-gray-500">Scheduled</p>
                                </div>
                                
                                <div class="flex items-center justify-center text-2xl text-gray-300">‚Üí</div>
                                
                                <div class="text-center">
                                    <div class="bg-indigo-100 rounded-lg p-4 mb-2">
                                        <p class="text-3xl font-bold text-indigo-700">${state.patientRequests.filter(r => r.status === 'in-progress').length}</p>
                                    </div>
                                    <p class="text-sm font-semibold text-gray-700">In Progress</p>
                                    <p class="text-xs text-gray-500">Service active</p>
                                </div>
                                
                                <div class="flex items-center justify-center text-2xl text-gray-300">‚Üí</div>
                                
                                <div class="text-center">
                                    <div class="bg-green-100 rounded-lg p-4 mb-2">
                                        <p class="text-3xl font-bold text-green-700">${completedRequests}</p>
                                    </div>
                                    <p class="text-sm font-semibold text-gray-700">Completed</p>
                                    <p class="text-xs text-gray-500">$${totalRevenue} earned</p>
                                </div>
                            </div>
                        </div>

                        <!-- HORIZONTAL Provider Performance Table -->
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Provider Performance</h3>
                                <div class="flex gap-2">
                                    <button onclick="sortProviders('revenue')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Sort by Revenue</button>
                                    <button onclick="sortProviders('completed')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Sort by Completed</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                                        <tr>
                                            <th class="text-left p-3 font-semibold">Rank</th>
                                            <th class="text-left p-3 font-semibold">Provider</th>
                                            <th class="text-center p-3 font-semibold">Status</th>
                                            <th class="text-center p-3 font-semibold">Total</th>
                                            <th class="text-center p-3 font-semibold">Pending</th>
                                            <th class="text-center p-3 font-semibold">Active</th>
                                            <th class="text-center p-3 font-semibold">Completed</th>
                                            <th class="text-right p-3 font-semibold">Revenue</th>
                                            <th class="text-right p-3 font-semibold">Avg/Service</th>
                                            <th class="text-center p-3 font-semibold">Rating</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        ${providerPerformance.map((provider, index) => `
                                            <tr class="hover:bg-gray-50 ${provider.available ? 'bg-green-50' : ''}">
                                                <td class="p-3">
                                                    ${index < 3 ? `<span class="text-lg">${['ü•á', 'ü•à', 'ü•â'][index]}</span>` : `<span class="text-gray-400 font-semibold">#${index + 1}</span>`}
                                                </td>
                                                <td class="p-3">
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                                            ${provider.name.split(' ').map(n => n[0]).join('')}
                                                        </div>
                                                        <div>
                                                            <p class="font-semibold">${provider.name}</p>
                                                            <p class="text-xs text-gray-500">${provider.specialty}</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="p-3 text-center">
                                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${provider.available ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                                        ${provider.available ? '‚óè Online' : '‚óã Offline'}
                                                    </span>
                                                </td>
                                                <td class="p-3 text-center font-semibold">${provider.requestCount}</td>
                                                <td class="p-3 text-center ${provider.pendingCount > 0 ? 'text-yellow-600 font-bold' : 'text-gray-400'}">${provider.pendingCount}</td>
                                                <td class="p-3 text-center ${provider.activeCount > 0 ? 'text-blue-600 font-bold' : 'text-gray-400'}">${provider.activeCount}</td>
                                                <td class="p-3 text-center text-green-600 font-bold">${provider.completedCount}</td>
                                                <td class="p-3 text-right text-purple-600 font-bold">$${provider.revenue}</td>
                                                <td class="p-3 text-right text-gray-600">$${provider.avgRevenue}</td>
                                                <td class="p-3 text-center">‚≠ê ${provider.rating}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <!-- Service Analytics -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-xl font-bold mb-4">Service Analytics</h3>
                                <div class="space-y-3">
                                    ${Object.keys(serviceBreakdown).length > 0 ? Object.entries(serviceBreakdown).map(([serviceName, data]) => {
                                        const service = services.find(s => s.name === serviceName);
                                        const completionRate = data.count > 0 ? Math.round((data.completed / data.count) * 100) : 0;
                                        return `
                                            <div class="border rounded-lg p-3 hover:bg-gray-50 transition">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-2xl">${service ? service.icon : 'üìã'}</span>
                                                        <div>
                                                            <span class="font-semibold">${serviceName}</span>
                                                            <span class="text-xs text-gray-500 ml-2">${data.count} requests</span>
                                                        </div>
                                                    </div>
                                                    <span class="text-sm font-bold text-indigo-600">$${data.avgPrice} avg</span>
                                                </div>
                                                <div class="flex gap-4 text-xs">
                                                    <div><span class="text-gray-500">Completed:</span> <span class="font-semibold">${data.completed}</span></div>
                                                    <div><span class="text-gray-500">Revenue:</span> <span class="font-semibold text-green-600">$${data.revenue}</span></div>
                                                    <div><span class="text-gray-500">Rate:</span> <span class="font-semibold">${completionRate}%</span></div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : '<p class="text-gray-500 text-center py-8">No service data yet</p>'}
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
                                <div class="space-y-3">
                                    <button onclick="broadcastMessage()" class="w-full text-left px-4 py-3 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">üì¢</span>
                                            <div>
                                                <p class="font-semibold text-indigo-900">Broadcast Message</p>
                                                <p class="text-xs text-indigo-600">Send notification to all providers</p>
                                            </div>
                                        </div>
                                    </button>
                                    
                                    <button onclick="toggleAllProviders()" class="w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">üîÑ</span>
                                            <div>
                                                <p class="font-semibold text-blue-900">Toggle All Providers</p>
                                                <p class="text-xs text-blue-600">Turn all providers online/offline</p>
                                            </div>
                                        </div>
                                    </button>
                                    
                                    <button onclick="viewDetailedAnalytics()" class="w-full text-left px-4 py-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">üìà</span>
                                            <div>
                                                <p class="font-semibold text-purple-900">Detailed Analytics</p>
                                                <p class="text-xs text-purple-600">View comprehensive reports</p>
                                            </div>
                                        </div>
                                    </button>
                                    
                                    <button onclick="manageProviders()" class="w-full text-left px-4 py-3 bg-green-50 hover:bg-green-100 rounded-lg transition">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">üë•</span>
                                            <div>
                                                <p class="font-semibold text-green-900">Manage Providers</p>
                                                <p class="text-xs text-green-600">Add, edit, or remove providers</p>
                                            </div>
                                        </div>
                                    </button>
                                    
                                    <button onclick="reviewPendingRequests()" class="w-full text-left px-4 py-3 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">‚ö†Ô∏è</span>
                                            <div>
                                                <p class="font-semibold text-yellow-900">Review Pending (${pendingRequests})</p>
                                                <p class="text-xs text-yellow-600">Manually assign providers if needed</p>
                                            </div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Request Timeline -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Live Request Timeline</h3>
                                <div class="flex gap-2 items-center">
                                    <select onchange="filterTimeline(this.value)" class="text-sm px-3 py-1 border rounded">
                                        <option value="all">All Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="matched">Matched</option>
                                        <option value="accepted">Accepted</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                    <span class="text-sm text-gray-500">${totalRequests} total</span>
                                </div>
                            </div>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${requestTimeline.length > 0 ? requestTimeline.map(req => `
                                    <div class="border rounded-lg p-4 hover:bg-gray-50 transition">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <span class="text-2xl">${req.icon || 'üìã'}</span>
                                                    <div>
                                                        <p class="font-semibold text-gray-900">${req.service}</p>
                                                        <p class="text-xs text-gray-500">ID: ${req.id} ‚Ä¢ ${req.ageMinutes}m ago</p>
                                                    </div>
                                                </div>
                                                ${req.description ? `<p class="text-sm text-gray-600 mb-2">${req.description}</p>` : ''}
                                                <div class="flex items-center gap-4 text-xs text-gray-500">
                                                    <span>‚è±Ô∏è ${req.time}</span>
                                                    ${req.provider ? `<span>üë®‚Äç‚öïÔ∏è ${req.provider}</span>` : '<span>üë®‚Äç‚öïÔ∏è Unassigned</span>'}
                                                    ${req.scheduledTime ? `<span>üìÖ ${req.scheduledTime}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="text-right ml-4">
                                                <p class="text-2xl font-bold text-indigo-600 mb-2">$${req.price}</p>
                                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                                                    req.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                                    req.status === 'matched' ? 'bg-orange-100 text-orange-800' :
                                                    req.status === 'accepted' ? 'bg-blue-100 text-blue-800' :
                                                    req.status === 'in-progress' ? 'bg-indigo-100 text-indigo-800' :
                                                    'bg-green-100 text-green-800'
                                                }">${req.status.toUpperCase()}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-gray-500 text-center py-8">No requests yet</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // Admin Action Functions
        function exportData() {
            const data = {
                requests: state.patientRequests,
                providers: state.providers,
                exportDate: new Date().toISOString(),
                summary: {
                    totalRequests: state.patientRequests.length,
                    totalRevenue: state.patientRequests.filter(r => r.status === 'completed').reduce((sum, r) => sum + r.price, 0),
                    activeProviders: state.providers.filter(p => p.available).length
                }
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `medangels-export-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Data exported successfully!');
        }
        
        function broadcastMessage() {
            const message = prompt('Enter message to broadcast to all providers:');
            if (message) {
                alert(`üì¢ Broadcasting to ${state.providers.length} providers:\n\n"${message}"\n\n(In production, this would send push notifications)`);
            }
        }
        
        function toggleAllProviders() {
            const allOnline = state.providers.every(p => p.available);
            state.providers.forEach(p => p.available = !allOnline);
            render();
            alert(`‚úÖ All providers turned ${allOnline ? 'OFFLINE' : 'ONLINE'}`);
        }
        
        function viewDetailedAnalytics() {
            alert('üìà Detailed Analytics Dashboard\n\n(In production, this would open:\n- Revenue trends\n- Geographic heatmaps\n- Service demand forecasting\n- Provider performance trends\n- Patient satisfaction metrics)');
        }
        
        function manageProviders() {
            alert('üë• Provider Management\n\n(In production, this would allow:\n- Add new providers\n- Edit provider details\n- Suspend/activate providers\n- Set availability schedules\n- Manage certifications)');
        }
        
        function reviewPendingRequests() {
            const pending = state.patientRequests.filter(r => r.status === 'pending' || r.status === 'matched');
            if (pending.length === 0) {
                alert('‚úÖ No pending requests to review!');
                return;
            }
            
            alert(`‚ö†Ô∏è Reviewing ${pending.length} Pending Requests\n\n(In production, this would show:\n- Manual provider assignment\n- Request prioritization\n- Patient contact options\n- Escalation tools)`);
        }
        
        function sortProviders(sortBy) {
            // This would trigger a re-render with different sort
            alert(`Sorting by ${sortBy}...\n\n(In production, this would dynamically resort the table)`);
        }
        
        function filterTimeline(status) {
            // This would filter the timeline view
            if (status === 'all') {
                alert('Showing all requests');
            } else {
                const count = state.patientRequests.filter(r => r.status === status).length;
                alert(`Filtering to ${count} ${status} requests\n\n(In production, this would filter the timeline dynamically)`);
            }
        }

        function selectRole(role) {
            state.currentRole = role;
            if (role === 'provider') {
                showProviderLoginModal();
            } else if (role === 'patient') {
                showPatientLoginModal();
            } else {
                changeView(role);
            }
        }

        function selectRole(role) {
            state.currentRole = role;
            if (role === 'provider') {
                state.showModal = 'provider';
                render();
            } else if (role === 'patient') {
                state.showModal = 'patient';
                render();
            } else {
                changeView(role);
            }
        }
        
        function getModalHTML() {
            if (state.showModal === 'patient') {
                return `
                    <div class="fixed inset-0 z-50 overflow-y-auto modal-backdrop">
                        <div class="flex items-center justify-center min-h-screen px-4">
                            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="closeModal()"></div>
                            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative z-10 modal-content">
                                <div class="text-center mb-6">
                                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span class="text-4xl">üë§</span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Welcome to MedAngels</h3>
                                    <p class="text-gray-600">Access your patient account</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <button onclick="startPatientRegistration()" 
                                        class="w-full bg-indigo-600 text-white py-4 rounded-xl hover:bg-indigo-700 transition-all duration-200 font-semibold flex items-center justify-center gap-2 hover:shadow-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                        </svg>
                                        Create New Account
                                    </button>
                                    
                                    <button onclick="loginExistingPatient()" 
                                        class="w-full bg-white border-2 border-gray-300 text-gray-700 py-4 rounded-xl hover:border-indigo-600 hover:text-indigo-600 transition-all duration-200 font-semibold flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                                        </svg>
                                        Sign In
                                    </button>
                                </div>
                                
                                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (state.showModal === 'provider') {
                return `
                    <div class="fixed inset-0 z-50 overflow-y-auto modal-backdrop">
                        <div class="flex items-center justify-center min-h-screen px-4">
                            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="closeModal()"></div>
                            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative z-10 modal-content">
                                <div class="text-center mb-6">
                                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span class="text-4xl">‚öïÔ∏è</span>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Provider Portal</h3>
                                    <p class="text-gray-600">Join our network of healthcare providers</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <button onclick="startProviderOnboarding()" 
                                        class="w-full bg-indigo-600 text-white py-4 rounded-xl hover:bg-indigo-700 transition-all duration-200 font-semibold flex items-center justify-center gap-2 hover:shadow-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Register as Provider
                                    </button>
                                    
                                    <button onclick="showProviderSelection()" 
                                        class="w-full bg-white border-2 border-gray-300 text-gray-700 py-4 rounded-xl hover:border-indigo-600 hover:text-indigo-600 transition-all duration-200 font-semibold flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                                        </svg>
                                        Provider Login
                                    </button>
                                </div>
                                
                                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (state.showModal === 'provider-select') {
                return `
                    <div class="fixed inset-0 z-50 overflow-y-auto modal-backdrop">
                        <div class="flex items-center justify-center min-h-screen px-4">
                            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="closeModal()"></div>
                            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8 relative z-10 modal-content max-h-[90vh] overflow-y-auto">
                                <div class="text-center mb-6">
                                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Select Provider Account</h3>
                                    <p class="text-gray-600">Choose which provider to login as</p>
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-3 mb-4">
                                    ${state.providers.map((provider, index) => `
                                        <button onclick="loginAsProvider(${index})" 
                                            class="text-left p-4 border-2 border-gray-200 rounded-xl hover:border-indigo-600 hover:bg-indigo-50 transition-all duration-200 group">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                                    ${provider.name.split(' ').map(n => n[0]).join('')}
                                                </div>
                                                <div class="flex-1">
                                                    <p class="font-bold text-gray-900 group-hover:text-indigo-600">${provider.name}</p>
                                                    <p class="text-sm text-gray-500">${provider.specialty}</p>
                                                </div>
                                                ${provider.available ? '<span class="w-3 h-3 bg-green-500 rounded-full"></span>' : '<span class="w-3 h-3 bg-gray-300 rounded-full"></span>'}
                                            </div>
                                            <div class="flex items-center justify-between text-xs text-gray-500">
                                                <span>‚≠ê ${provider.rating}</span>
                                                <span>${provider.completed} services</span>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                                
                                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return '';
        }
        
        function closeModal() {
            state.showModal = null;
            render();
        }
        
        function toggleAIAssistant() {
            state.showAIPanel = !state.showAIPanel;
            render();
            if (state.showAIPanel) {
                setTimeout(() => {
                    const input = document.getElementById('aiInput');
                    if (input) input.focus();
                }, 100);
            }
        }
        
        function loginExistingPatient() {
            state.currentPatient = { 
                name: 'John Doe', 
                email: 'john@example.com',
                registered: true 
            };
            state.showModal = null;
            changeView('patient');
        }
        
        function showProviderSelection() {
            state.showModal = 'provider-select';
            render();
        }
        
        function loginAsProvider(index) {
            state.currentProvider = state.providers[index];
            state.showModal = null;
            changeView('provider');
        }

        function showPatientLoginModal() {
            state.showModal = 'patient';
            render();
        }

        function startPatientRegistration() {
            state.patientRegistrationData = {};
            state.patientRegistrationStep = 1;
            state.showModal = null;
            changeView('patient-registration');
        }

        function showProviderLoginModal() {
            state.showModal = 'provider';
            render();
        }

        function startProviderOnboarding() {
            state.currentRole = 'provider';
            state.currentProvider = null;
            state.onboardingData = {};
            state.onboardingStep = 1;
            changeView('provider-onboarding');
        }

        function changeView(view) {
            state.currentView = view;
            render();
        }

        function toggleAvailability() {
            if (state.currentProvider) {
                state.currentProvider.available = !state.currentProvider.available;
                const provider = state.providers.find(p => p.id === state.currentProvider.id);
                if (provider) provider.available = state.currentProvider.available;
            }
            render();
        }

        function selectService(serviceId) {
            state.selectedService = serviceId;
            changeView('service-form');
        }

        function backToServiceSelection() {
            state.selectedService = null;
            changeView('patient');
        }

        function updatePriceEstimate() {
            const form = document.getElementById('serviceForm');
            if (!form) return;

            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (value) data[key] = value;
            }

            const price = calculatePrice(state.selectedService, data);
            const priceElement = document.getElementById('priceEstimate');
            if (priceElement) {
                priceElement.textContent = `$${price}`;
            }
        }

        function submitServiceForm(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            const service = services.find(s => s.id === state.selectedService);
            const price = calculatePrice(state.selectedService, data);

            state.pendingRequest = {
                id: state.requestCounter++,
                service: service.name,
                icon: service.icon,
                time: service.time,
                formData: data,
                price: price,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            changeView('price-confirmation');
        }

        function acceptRequest() {
            if (!state.pendingRequest) return;

            const request = {
                ...state.pendingRequest,
                status: 'pending'
            };

            state.patientRequests.push(request);
            state.providerRequests.push({...request});
            state.pendingRequest = null;

            // Simulate provider matching
            setTimeout(() => {
                matchProviderToRequest(request.id);
            }, 2000);

            changeView('patient');
        }

        function matchProviderToRequest(requestId) {
            const request = state.patientRequests.find(r => r.id === requestId);
            if (!request) return;

            // Find the service ID from the request
            const service = services.find(s => s.name === request.service);
            const serviceId = service ? service.id : null;

            // Filter providers who: 1) are available, 2) offer this service
            const matchingProviders = state.providers.filter(p => 
                p.available && p.services && p.services.includes(serviceId)
            );

            if (matchingProviders.length === 0) {
                // No matching providers available, try any available provider as fallback
                const anyAvailable = state.providers.filter(p => p.available);
                if (anyAvailable.length === 0) return;
            }

            const provider = matchingProviders.length > 0 ? matchingProviders[0] : state.providers.filter(p => p.available)[0];
            const providerRequest = state.providerRequests.find(r => r.id === requestId);

            if (request && providerRequest) {
                // Simulate provider acceptance
                setTimeout(() => {
                    request.status = 'matched';
                    providerRequest.status = 'pending';
                    render();
                }, 1500);
            }
        }

        function createRequestFromAI(serviceId, formData, description) {
            const service = services.find(s => s.id === serviceId);
            const price = calculatePrice(serviceId, formData);

            const request = {
                id: state.requestCounter++,
                service: service.name,
                icon: service.icon,
                time: service.time,
                formData: formData,
                description: description,
                price: price,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            state.patientRequests.push(request);
            state.providerRequests.push({...request});

            // Simulate provider matching
            setTimeout(() => {
                matchProviderToRequest(request.id);
            }, 2000);

            changeView('patient');
        }

        function acceptProviderRequest(requestId) {
            const request = state.providerRequests.find(r => r.id === requestId);
            if (!request) return;

            request.status = 'accepted';
            request.provider = state.currentProvider ? state.currentProvider.name : 'Provider';
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(10, 0, 0, 0);
            request.scheduledTime = tomorrow.toLocaleString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit'
            });

            const patientRequest = state.patientRequests.find(r => r.id === requestId);
            if (patientRequest) {
                patientRequest.status = 'accepted';
                patientRequest.provider = request.provider;
                patientRequest.scheduledTime = request.scheduledTime;
            }

            render();
        }

        function declineRequest(requestId) {
            const index = state.providerRequests.findIndex(r => r.id === requestId);
            if (index > -1) {
                state.providerRequests.splice(index, 1);
            }
            render();
        }

        function startService(requestId) {
            const request = state.providerRequests.find(r => r.id === requestId);
            if (request) {
                request.status = 'in-progress';
                const patientRequest = state.patientRequests.find(r => r.id === requestId);
                if (patientRequest) patientRequest.status = 'in-progress';
            }
            render();
        }

        function completeService(requestId) {
            const request = state.providerRequests.find(r => r.id === requestId);
            if (request) {
                request.status = 'completed';
                const patientRequest = state.patientRequests.find(r => r.id === requestId);
                if (patientRequest) patientRequest.status = 'completed';
            }
            render();
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            if (!message) return;

            state.aiMessages.push({ role: 'user', content: message });
            input.value = '';
            render();

            // Scroll to bottom
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);

            // Simulate AI processing
            setTimeout(() => {
                const response = processAIConversation(message);
                state.aiMessages.push({ role: 'assistant', content: response.message });
                
                if (response.newState) {
                    state.aiState = response.newState;
                }
                if (response.context) {
                    state.aiContext = { ...state.aiContext, ...response.context };
                }

                render();

                // Scroll to bottom again after AI response
                setTimeout(() => {
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);

                // If ready to create request, show confirmation
                if (response.ready && state.aiContext.serviceId) {
                    setTimeout(() => {
                        showAIRequestConfirmation();
                    }, 1000);
                }
            }, 800);
        }

        function processAIConversation(message) {
            const lower = message.toLowerCase();

            // Initial state - identify service type
            if (state.aiState === 'initial') {
                let serviceId = null;
                let serviceName = '';

                if (lower.includes('physical') || lower.includes('therapy') || lower.includes('back') || lower.includes('knee') || lower.includes('pain')) {
                    serviceId = 'physical';
                    serviceName = 'Physical Therapy';
                } else if (lower.includes('urgent') || lower.includes('emergency') || lower.includes('immediate')) {
                    serviceId = 'urgent';
                    serviceName = 'Urgent Care';
                } else if (lower.includes('nurse') || lower.includes('injection') || lower.includes('wound') || lower.includes('iv')) {
                    serviceId = 'nurse';
                    serviceName = 'Nursing Visit';
                } else if (lower.includes('blood') || lower.includes('lab') || lower.includes('test')) {
                    serviceId = 'lab';
                    serviceName = 'Lab/Blood Draw';
                } else if (lower.includes('mental') || lower.includes('therapy') || lower.includes('counseling') || lower.includes('anxiety') || lower.includes('depression')) {
                    serviceId = 'mental';
                    serviceName = 'Mental Health';
                } else if (lower.includes('chiro') || lower.includes('spine') || lower.includes('adjustment')) {
                    serviceId = 'chiro';
                    serviceName = 'Chiropractor';
                } else {
                    serviceId = 'primary';
                    serviceName = 'Primary Care';
                }

                state.aiContext = { 
                    serviceId, 
                    serviceName,
                    userInput: message,
                    formData: {}
                };

                // Ask first clarifying question based on service
                const config = serviceFormConfigs[serviceId];
                const firstField = config.fields[0];
                
                return {
                    message: `I understand you need ${serviceName}. To give you an accurate price, I need to ask a few questions.\n\n${firstField.label}${firstField.type === 'select' ? '\n\nOptions: ' + firstField.options.join(', ') : ''}`,
                    newState: 'gathering',
                    context: { currentFieldIndex: 0 }
                };
            }

            // Gathering information state
            if (state.aiState === 'gathering') {
                const config = serviceFormConfigs[state.aiContext.serviceId];
                const currentField = config.fields[state.aiContext.currentFieldIndex];
                
                // Store the answer
                state.aiContext.formData[currentField.name] = message;

                const nextIndex = state.aiContext.currentFieldIndex + 1;

                // Check if we have more questions
                if (nextIndex < config.fields.length) {
                    const nextField = config.fields[nextIndex];
                    return {
                        message: `Got it. Next question:\n\n${nextField.label}${nextField.type === 'select' ? '\n\nOptions: ' + nextField.options.join(', ') : ''}`,
                        context: { currentFieldIndex: nextIndex }
                    };
                } else {
                    // All questions answered, calculate price
                    const price = calculatePrice(state.aiContext.serviceId, state.aiContext.formData);
                    state.aiContext.price = price;
                    const service = services.find(s => s.id === state.aiContext.serviceId);

                    return {
                        message: `Perfect! Based on your needs, I've calculated the price for ${state.aiContext.serviceName}:\n\n√∞≈∏‚Äô¬∞ Final Price: $${price}\n√¢¬è¬±√Ø¬∏¬è Duration: ${service.time}\n\nWould you like to proceed with this request?`,
                        newState: 'confirming',
                        ready: true
                    };
                }
            }

            // Default response
            return {
                message: "I'm here to help you find the right medical service. Could you describe what you need?"
            };
        }

        function showAIRequestConfirmation() {
            const userConfirmed = confirm(
                `Ready to request ${state.aiContext.serviceName} for $${state.aiContext.price}?\n\nClick OK to find an available provider.`
            );

            if (userConfirmed) {
                createRequestFromAI(
                    state.aiContext.serviceId,
                    state.aiContext.formData,
                    state.aiContext.userInput
                );
                
                // Reset AI state
                state.aiMessages = [];
                state.aiContext = {};
                state.aiState = 'initial';
            }
        }

        function submitPatientRegStep1(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            for (let [key, value] of formData.entries()) {
                state.patientRegistrationData[key] = value;
            }
            
            state.patientRegistrationStep = 2;
            render();
        }

        function submitPatientRegStep2(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            for (let [key, value] of formData.entries()) {
                state.patientRegistrationData[key] = value;
            }
            
            state.patientRegistrationStep = 3;
            render();
        }

        function submitPatientRegStep3(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const paymentType = formData.get('paymentType');
            if (!paymentType) {
                alert('Please select a payment method');
                return;
            }
            
            for (let [key, value] of formData.entries()) {
                state.patientRegistrationData[key] = value;
            }
            
            state.patientRegistrationStep = 4;
            render();
        }

        function goToPatientRegStep(step) {
            state.patientRegistrationStep = step;
            render();
        }

        function updatePaymentForm() {
            const insuranceFields = document.getElementById('insuranceFields');
            const creditFields = document.getElementById('creditFields');
            const hsaFields = document.getElementById('hsaFields');
            const financingFields = document.getElementById('financingFields');
            const paymentType = document.querySelector('input[name="paymentType"]:checked');
            
            // Hide all
            insuranceFields?.classList.add('hidden');
            creditFields?.classList.add('hidden');
            hsaFields?.classList.add('hidden');
            financingFields?.classList.add('hidden');
            
            // Clear required
            document.getElementById('insuranceProviderSelect')?.removeAttribute('required');
            document.getElementById('memberIdInput')?.removeAttribute('required');
            document.getElementById('cardNumberInput')?.removeAttribute('required');
            document.getElementById('cardExpiryInput')?.removeAttribute('required');
            document.getElementById('cardCvvInput')?.removeAttribute('required');
            document.getElementById('cardNameInput')?.removeAttribute('required');
            document.getElementById('hsaTypeSelect')?.removeAttribute('required');
            document.getElementById('hsaCardInput')?.removeAttribute('required');
            document.getElementById('financingPartnerSelect')?.removeAttribute('required');
            
            // Show relevant
            if (paymentType?.value === 'insurance') {
                insuranceFields?.classList.remove('hidden');
                document.getElementById('insuranceProviderSelect')?.setAttribute('required', 'required');
                document.getElementById('memberIdInput')?.setAttribute('required', 'required');
            } else if (paymentType?.value === 'credit') {
                creditFields?.classList.remove('hidden');
                document.getElementById('cardNumberInput')?.setAttribute('required', 'required');
                document.getElementById('cardExpiryInput')?.setAttribute('required', 'required');
                document.getElementById('cardCvvInput')?.setAttribute('required', 'required');
                document.getElementById('cardNameInput')?.setAttribute('required', 'required');
            } else if (paymentType?.value === 'hsa') {
                hsaFields?.classList.remove('hidden');
                document.getElementById('hsaTypeSelect')?.setAttribute('required', 'required');
                document.getElementById('hsaCardInput')?.setAttribute('required', 'required');
            } else if (paymentType?.value === 'financing') {
                financingFields?.classList.remove('hidden');
                document.getElementById('financingPartnerSelect')?.setAttribute('required', 'required');
            }
        }

        function completePatientRegistration() {
            const data = state.patientRegistrationData;
            state.currentPatient = {
                name: `${data.firstName} ${data.lastName}`,
                email: data.email,
                phone: data.phone,
                registered: true,
                ...data
            };
            
            state.patientRegistrationData = {};
            state.patientRegistrationStep = 1;
            
            alert('üéâ Registration complete! Welcome to MedAngels, ' + state.currentPatient.name + '!');
            changeView('patient');
        }

        function submitOnboardingStep1(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            for (let [key, value] of formData.entries()) {
                state.onboardingData[key] = value;
            }
            
            state.onboardingStep = 2;
            render();
        }

        function submitOnboardingStep2(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            // Get all checked services
            const services = [];
            for (let [key, value] of formData.entries()) {
                if (key === 'services') {
                    services.push(value);
                } else {
                    state.onboardingData[key] = value;
                }
            }
            
            if (services.length === 0) {
                alert('Please select at least one service');
                return;
            }
            
            state.onboardingData.services = services;
            state.onboardingStep = 3;
            render();
        }

        function submitOnboardingStep3(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const compensationType = formData.get('compensationType');
            if (!compensationType) {
                alert('Please select a compensation type');
                return;
            }
            
            state.onboardingData.compensationType = compensationType;
            
            if (compensationType === 'donate-proceeds') {
                const charity = formData.get('charity');
                if (!charity) {
                    alert('Please select a charity');
                    return;
                }
                state.onboardingData.charity = charity;
            }
            
            state.onboardingStep = 4;
            render();
        }

        function goToOnboardingStep(step) {
            state.onboardingStep = step;
            render();
        }

        function updateCompensationForm() {
            const charitySelection = document.getElementById('charitySelection');
            const charityDropdown = document.getElementById('charityDropdown');
            const compensationType = document.querySelector('input[name="compensationType"]:checked');
            
            if (compensationType && compensationType.value === 'donate-proceeds') {
                charitySelection.classList.remove('hidden');
                charityDropdown.required = true;
            } else {
                charitySelection.classList.add('hidden');
                charityDropdown.required = false;
            }
        }

        function completeOnboarding() {
            // Create new provider from onboarding data
            const data = state.onboardingData;
            const newProvider = {
                id: state.providers.length + 1,
                name: data.fullName,
                title: data.title,
                specialty: services.find(s => data.services.includes(s.id))?.name || 'Medical Professional',
                available: false,
                rating: 5.0,
                completed: 0,
                licenseNumber: data.licenseNumber,
                state: data.state,
                experience: data.experience,
                phone: data.phone,
                email: data.email,
                services: data.services,
                serviceZip: data.serviceZip,
                travelRadius: data.travelRadius,
                compensationType: data.compensationType,
                charity: data.charity,
                onboarded: true
            };
            
            state.providers.push(newProvider);
            state.currentProvider = newProvider;
            
            // Reset onboarding state
            state.onboardingData = {};
            state.onboardingStep = 1;
            
            // Show success message
            alert('√∞≈∏≈Ω‚Ä∞ Registration complete! Welcome to MedAngels, ' + newProvider.name + '!');
            
            // Navigate to provider portal
            changeView('provider');
        }

        function attachEventListeners() {
            // Event listeners are attached via onclick in HTML
        }

        // Initial render
        render();
    </script>
</body>
</html>